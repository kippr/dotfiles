#!/usr/bin/env ruby
# Pipe the results of a git (show/log) --numstat into this to see summary of changes

class Array
    def sum
        inject{|x,y| x + y}
    end
end

NUMSTAT_RE = /^(\d+)\s+(\d+)\s+(\S+)$/

numstats = ARGF.each_line.collect{|l| l.match(NUMSTAT_RE)}.compact.collect(&:captures)

numstats = numstats.collect do |added, deleted, name|
    [name, added.to_i - deleted.to_i, added.to_i, deleted.to_i]
end

def filetype filename
    filetype = filename.match(/\.([^\.]*)$/)[1]
    {'py' => 'Python', 'rb' => 'Ruby'}.fetch(filetype, filetype)
end

def fileclass filename
    case filename
    when /test(s)?\./
        'Tests'
    when /spec(_helper)?\.rb$/
        'Specs'
    else
        'Production'
    end
end

def category filename
    [filetype(filename), fileclass(filename)]
end

categorized = numstats.group_by{ |name,*| category(name) }.sort

categorized.each do |type_and_class,data|
    filetype, fileclass = type_and_class
    totals = data.inject([0,0,0]) do |totals,filedata|
        totals.zip(filedata[1..-1]).collect(&:sum)
    end
    puts "#{totals[0]}\t+#{totals[1]}\t-#{totals[2]}\t#{filetype} / #{fileclass}"
end
